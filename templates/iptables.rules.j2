# -----------------------------------------------------------------------------
# iptables-restore configuration generated by the firewall role (IPv{{ ip_version | default(4) }})
#
# Default policies come from `firewall.inbound/outbound/forwarded.default_policy`.
# Rule entries are read from the corresponding `firewall.*.rules` lists.
# Each rule supports keys like:
#   action, protocol, dport, sport, interface, out_interface, source,
#   destination, ctstate, extra
# -----------------------------------------------------------------------------

{% macro format_rule(chain, rule) -%}
-A {{ chain }}
{%- if rule.interface is defined %} -i {{ rule.interface }}{% endif %}
{%- if rule.out_interface is defined %} -o {{ rule.out_interface }}{% endif %}
{%- if rule.protocol is defined %} -p {{ rule.protocol }}{% endif %}
{%- if rule.source is defined %} -s {{ rule.source }}{% endif %}
{%- if rule.destination is defined %} -d {{ rule.destination }}{% endif %}
{%- if rule.sport is defined %} --sport {{ rule.sport }}{% endif %}
{%- if rule.dport is defined %} --dport {{ rule.dport }}{% endif %}
{%- if rule.ctstate is defined %} -m conntrack --ctstate {{ rule.ctstate }}{% endif %}
{%- if rule.extra is defined %} {{ rule.extra }}{% endif %}
 -j {{ (rule.action | default('ACCEPT')) | upper }}
{%- endmacro %}

{% set inbound_policy = (firewall.inbound.default_policy | default('DROP')) | upper %}
{% set outbound_policy = (firewall.outbound.default_policy | default('ACCEPT')) | upper %}
{% set forward_policy = (firewall.forwarded.default_policy | default('DROP')) | upper %}

*filter
:INPUT {{ inbound_policy }} [0:0]
:FORWARD {{ forward_policy }} [0:0]
:OUTPUT {{ outbound_policy }} [0:0]

# Allow established/related and loopback traffic
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Inbound rules
{% for rule in firewall.inbound.rules | default([]) %}
{{ format_rule('INPUT', rule) }}
{% endfor %}

# Outbound rules
{% for rule in firewall.outbound.rules | default([]) %}
{{ format_rule('OUTPUT', rule) }}
{% endfor %}

# Forwarded rules
{% for rule in firewall.forwarded.rules | default([]) %}
{{ format_rule('FORWARD', rule) }}
{% endfor %}

COMMIT

{% set nat_rules = firewall.nat.prerouting | default([]) %}
{% if ip_version == 4 and nat_rules|length > 0 %}
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

{% for rule in nat_rules %}
{% set dnat_dest = rule.match_dest | default(rule.destination) %}
-A PREROUTING{% if rule.interface is defined %} -i {{ rule.interface }}{% endif %}{% if rule.protocol is defined %} -p {{ rule.protocol }}{% endif %}{% if dnat_dest is defined %} -d {{ dnat_dest }}{% endif %}{% if rule.dport is defined %} --dport {{ rule.dport }}{% endif %}{% if rule.sport is defined %} --sport {{ rule.sport }}{% endif %} -j DNAT --to-destination {{ rule.to }}
{% endfor %}

COMMIT
{% endif %}
